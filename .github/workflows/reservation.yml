name: Desk Reservation Cron

on:
  schedule:
    - cron: "1 14 * * 1-5" # 9:01 AM Eastern (Winter EST)
    - cron: "1 13 * * 1-5" # 9:01 AM Eastern (Summer EDT)
  workflow_dispatch:
    inputs:
      user:
        description: 'User to run (user1, user2, etc., or "all")'
        required: false
        default: 'all'
        type: string

jobs:
  set-users:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      users: ${{ steps.set-users.outputs.users }}
    steps:
      - name: Install jq
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends jq
      
      - name: Parse users from USER_CONFIGS
        id: set-users
        env:
          USER_CONFIGS: ${{ secrets.USER_CONFIGS }}
        run: |
          if [ -z "$USER_CONFIGS" ]; then
            echo "Error: USER_CONFIGS secret not found"
            exit 1
          fi
          
          ALL_USERS=$(echo "$USER_CONFIGS" | jq -r 'keys[]' | jq -R -s -c 'split("\n")[:-1]')
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.user }}" ] && [ "${{ github.event.inputs.user }}" != "all" ]; then
            USER="${{ github.event.inputs.user }}"
            if echo "$USER_CONFIGS" | jq -e ".\"$USER\"" > /dev/null 2>&1; then
              echo "users=[\"$USER\"]" >> $GITHUB_OUTPUT
            else
              echo "Error: User '$USER' not found in USER_CONFIGS"
              exit 1
            fi
          else
            echo "users=$ALL_USERS" >> $GITHUB_OUTPUT
          fi

  run-reservation:
    needs: set-users
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      matrix:
        user: ${{ fromJSON(needs.set-users.outputs.users) }}
      fail-fast: false
      max-parallel: 20  # Limit concurrent jobs (free tier allows 20)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Shallow clone for faster checkout

      - name: Install jq
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends jq

      - name: Setup environment
        run: |
          cat > .env << EOF
          APPSPACE_HOST="${{ secrets.APPSPACE_HOST }}"
          BOOKING_START_UTC="${{ secrets.BOOKING_START_UTC }}"
          BOOKING_END_UTC="${{ secrets.BOOKING_END_UTC }}"
          USER_CONFIGS='${{ secrets.USER_CONFIGS }}'
          EOF

      - name: Run reservation for ${{ matrix.user }}
        env:
          USER: ${{ matrix.user }}
        continue-on-error: true  # Continue even if this step fails
        run: |
          chmod +x reserve.sh
          ./reserve.sh || {
            echo "::error::Reservation failed for user ${{ matrix.user }}"
            exit 1
          }

      - name: Report failure
        if: failure()
        run: |
          echo "::warning::Reservation job failed for user ${{ matrix.user }}"
          echo "Check logs above for details"
