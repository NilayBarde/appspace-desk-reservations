name: Desk Check-in Cron

on:
  schedule:
    # Run every weekday at 8:48 AM Eastern (13:48 UTC)
    # This checks in 12 minutes before typical 9:00 AM reservation start times
    - cron: "48 13 * * 1-5"
  workflow_dispatch:
    inputs:
      user:
        description: 'User to check in (enter their email address or "all")'
        required: false
        default: 'all'
        type: string

jobs:
  set-users:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      users: ${{ steps.set-users.outputs.users }}
    steps:
      - name: Install jq
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends jq
      
      - name: Parse users from USER_CONFIGS
        id: set-users
        env:
          USER_CONFIGS: ${{ secrets.USER_CONFIGS }}
        run: |
          if [ -z "$USER_CONFIGS" ]; then
            echo "Error: USER_CONFIGS secret not found"
            exit 1
          fi
          
          ALL_USERS=$(echo "$USER_CONFIGS" | jq -r 'keys[]' | jq -R -s -c 'split("\n")[:-1]')
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.user }}" ] && [ "${{ github.event.inputs.user }}" != "all" ]; then
            USER="${{ github.event.inputs.user }}"
            if echo "$USER_CONFIGS" | jq -e ".\"$USER\"" > /dev/null 2>&1; then
              echo "users=[\"$USER\"]" >> $GITHUB_OUTPUT
            else
              echo "Error: User '$USER' not found in USER_CONFIGS"
              exit 1
            fi
          else
            echo "users=$ALL_USERS" >> $GITHUB_OUTPUT
          fi

  run-checkin:
    needs: set-users
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      matrix:
        user: ${{ fromJSON(needs.set-users.outputs.users) }}
      fail-fast: false
      max-parallel: 20  # Limit concurrent jobs (free tier allows 20)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Shallow clone for faster checkout

      - name: Install jq
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends jq

      - name: Setup environment
        run: |
          cat > .env << EOF
          APPSPACE_HOST="${{ secrets.APPSPACE_HOST }}"
          USER_CONFIGS='${{ secrets.USER_CONFIGS }}'
          EOF

      - name: Run check-in for ${{ matrix.user }}
        env:
          USER: ${{ matrix.user }}
        continue-on-error: true  # Continue even if this step fails
        run: |
          chmod +x checkin.sh
          ./checkin.sh || {
            echo "::error::Check-in failed for user ${{ matrix.user }}"
            exit 1
          }

      - name: Report failure
        if: failure()
        run: |
          echo "::warning::Check-in job failed for user ${{ matrix.user }}"
          echo "Check logs above for details"
